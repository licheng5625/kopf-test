% Autogenerated translation of README.md by Texpad
% To stop this file being overwritten during the typeset process, please move or remove this header

\documentclass[12pt]{book}
\usepackage{graphicx}
\usepackage{fontspec}
\usepackage[utf8]{inputenc}
\usepackage[a4paper,left=.5in,right=.5in,top=.3in,bottom=0.3in]{geometry}
\setlength\parindent{0pt}
\setlength{\parskip}{\baselineskip}
\setmainfont{Helvetica Neue}
\usepackage{hyperref}
\pagestyle{plain}
\begin{document}

\chapter*{kopf-test}

\section*{How to use}

\begin{enumerate}
\item build main operator docker images

\texttt{
docker build -t kopf/operator-test .
}
\item build nats operator docker images

\texttt{
docker build -t cheng/nats-operator-test .
}
\item deploy admin role

```
kubectl apply -f role.yaml

```
\item deploy CRD

```
kubectl apply -f crd.yaml

```

```
kubectl apply -f nats\_crd.yaml

```

You will see 2 CRDs are created.
\item deploy operators

```
kubectl apply -f ./main\_operator/deployment.yaml

```

```
kubectl apply -f ./main\_operator/nats.yaml

```
\item deploy new CRD object (new tenant on boarding)

```
kubectl apply -f obj.yaml

```

in the log of the operator, you can see step 1 and step 2 are excuted in pre-defined sequence

```
2022-01-28 08:58:55,575] kopf.objects         [INFO    ] [default/kopf-example-1] step 1: upload blob! 
\end{enumerate}

[2022-01-28 08:58:55,578] kopf.objects         [INFO    ] [default/kopf-example-1] Handler 'create\emph{blob}storge' succeeded.

[2022-01-28 08:58:55,579] kopf.objects         [DEBUG   ] [default/kopf-example-1] Patching with: \{'metadata': \{'annotations': \{'kopf.zalando.org/create\emph{blob}storge': '\{"started":"2022-01-28T08:58:55.429661","stopped":"2022-01-28T08:58:55.578644","purpose":"create","retries":1,"success":true,"failure":false\}'\}\}, 'status': \{'kopf': \{'progress': \{'create\emph{blob}storge': \{'started': '2022-01-28T08:58:55.429661', 'stopped': '2022-01-28T08:58:55.578644', 'delayed': None, 'purpose': 'create', 'retries': 1, 'success': True, 'failure': False, 'message': None, 'subrefs': None\}\}\}, 'create\emph{blob}storge': \{'name': 'my\_blob'\}\}\}

[2022-01-28 08:58:55,610] kopf.objects         [DEBUG   ] [default/kopf-example-1] Sleeping was skipped because of the patch, 9.852868 seconds left.

[2022-01-28 08:58:55,715] kopf.objects         [DEBUG   ] [default/kopf-example-1] Sleeping for 9.716797 seconds for the delayed handlers.

[2022-01-28 08:59:05,410] kopf.objects         [DEBUG   ] [default/kopf-example-1] Patching with: \{'metadata': \{'annotations': \{'kopf.zalando.org/touch-dummy': '2022-01-28T08:59:05.410610'\}\}, 'status': \{'kopf': \{'dummy': '2022-01-28T08:59:05.410610'\}\}\}

[2022-01-28 08:59:05,557] kopf.objects         [DEBUG   ] [default/kopf-example-1] Handler 'create\_nats' is invoked.

[2022-01-28 08:59:05,558] kopf.objects         [INFO    ] [default/kopf-example-1] my\_blob is created 

[2022-01-28 08:59:05,560] kopf.objects         [INFO    ] [default/kopf-example-1] step 2: Creating nats! 

[2022-01-28 08:59:05,561] kopf.objects         [INFO    ] [default/kopf-example-1] Handler 'create\_nats' succeeded.
	```

\begin{verbatim}
create new nats object  
```
kubectl apply -f nats_obj.yaml

```

nats operator will create resource for nats. In the main operator's log, you can see the nats resource is created, step 3 is triggered.  `create new nats object` can be done via code in the main operator in `step 2` .

```

[2022-01-28 09:07:05,650] kopf.objects         [INFO    ] [default/nats-example-1] nats is created! 
\end{verbatim}

[2022-01-28 09:07:05,651] kopf.objects         [INFO    ] [default/nats-example-1] step 3: do something else! 
[2022-01-28 09:07:05,651] kopf.objects         [INFO    ] [default/nats-example-1] \{'type': 'ADDED', 'object': \{'apiVersion': 'kopf.dev/v1', 'kind': 'NatsExample', 'metadata': \{'annotations': \{'kubectl.kubernetes.io/last-applied-configuration': '\{"apiVersion":"kopf.dev/v1","kind":"NatsExample","metadata":\{"annotations":\{"someannotation":"somevalue"\},"labels":\{"somelabel":"somevalue"\},"name":"nats-example-1","namespace":"default"\},"spec":\{"duration":"1m","field":"value","items":["item1","item2"]\}\}n', 'someannotation': 'somevalue'\}, 'creationTimestamp': '2022-01-28T09:07:05Z', 'generation': 1, 'labels': \{'somelabel': 'somevalue'\}, 'managedFields': [\{'apiVersion': 'kopf.dev/v1', 'fieldsType': 'FieldsV1', 'fieldsV1': \{'f:metadata': \{'f:annotations': \{'.': \{\}, 'f:kubectl.kubernetes.io/last-applied-configuration': \{\}, 'f:someannotation': \{\}\}, 'f:labels': \{'.': \{\}, 'f:somelabel': \{\}\}\}, 'f:spec': \{'.': \{\}, 'f:duration': \{\}, 'f:field': \{\}, 'f:items': \{\}\}\}, 'manager': 'kubectl-client-side-apply', 'operation': 'Update', 'time': '2022-01-28T09:07:05Z'\}], 'name': 'nats-example-1', 'namespace': 'default', 'resourceVersion': '4171957', 'uid': 'c84fcc05-2df2-4187-afbc-66866ab24b77'\}, 'spec': \{'duration': '1m', 'field': 'value', 'items': ['item1', 'item2']\}\}\}

\begin{verbatim}
```
\end{verbatim}

\end{document}
